<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>After School Program</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Vue 2 -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ==================== ENHANCED THEME VARIABLES ==================== */
    :root{
      --bg:#071021;
      --panel: rgba(255,255,255,0.03);
      --card: rgba(255,255,255,0.02);
      --muted:#9fb0c8;
      --text:#e8f6ff;
      --accent1:#45e6ff;
      --accent2:#7c6bff;
      --danger:#ff6b6b;
      --success:#3ae27a;
      --glass: rgba(255,255,255,0.02);
      --radius:12px;
      --shadow: 0 18px 50px rgba(2,6,20,0.6);
      --maxwidth:1200px;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    
    /* Light theme override */
    body.light-theme {
      --bg: linear-gradient(180deg,#f3f8ff,#ffffff);
      --panel: rgba(10,20,40,0.02);
      --card: rgba(255,255,255,1);
      --muted:#4e5b66;
      --text:#071427;
      --accent1:#2065ff;
      --accent2:#00bfa6;
      --glass: rgba(11,31,45,0.02);
    }

    /* ==================== ENHANCED BASE STYLES ==================== */
    *{box-sizing:border-box;margin:0;padding:0}
    
    html,body{
      height:100%;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }
    
    body{
      background-image: 
        radial-gradient(at 0% 0%, rgba(69, 230, 255, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(124, 107, 255, 0.15) 0px, transparent 50%);
      background-attachment: fixed;
    }
    
    a{color:inherit;text-decoration:none}
    .container{max-width:var(--maxwidth);margin:26px auto;padding:16px;animation:fadeIn 0.6s ease-out}
    
    /* ==================== ENHANCED ANIMATIONS ==================== */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { transform: translateX(-100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    /* ---------------- Header ---------------- */
    header.app-header{
      display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-radius:10px;
      background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border:1px solid rgba(255,255,255,0.02);
      box-shadow: var(--shadow);
      position:sticky;top:14px;z-index:40;backdrop-filter: blur(8px);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent1));display:flex;align-items:center;justify-content:center;font-weight:800;color:#041427}
    .brand .title{font-weight:800;font-size:18px}
    .brand .sub{font-size:13px;color:var(--muted)}

    .hdr-controls{display:flex;align-items:center;gap:10px}
    .search{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
    .search input{border:0;background:transparent;color:var(--text);outline:none;width:220px}
    .btn{
      padding:8px 12px;
      border-radius:10px;
      border:0;
      cursor:pointer;
      font-weight:700;
      background:transparent;
      color:var(--text);
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position:relative;
      overflow:hidden;
    }
    .btn::before{
      content:'';
      position:absolute;
      top:50%;
      left:50%;
      width:0;
      height:0;
      border-radius:50%;
      background:rgba(255,255,255,0.3);
      transform:translate(-50%, -50%);
      transition:width 0.6s, height 0.6s;
    }
    .btn:active::before{
      width:300px;
      height:300px;
    }
    .btn:hover:not(:disabled){
      transform:translateY(-2px);
    }
    .btn:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    .btn.ghost{
      background:transparent;
      border:1px solid rgba(255,255,255,0.02);
    }
    .btn.ghost:hover:not(:disabled){
      border-color:var(--accent1);
      background:rgba(69,230,255,0.05);
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--accent1),var(--accent2));
      color:#041427;
      box-shadow:0 4px 15px rgba(69,230,255,0.3);
    }
    .btn.primary:hover:not(:disabled){
      box-shadow:0 6px 20px rgba(69,230,255,0.5);
      transform:translateY(-3px);
    }

    /* ---------------- Layout ---------------- */
    .page{display:grid;grid-template-columns:1fr 380px;gap:20px;margin-top:20px}
    @media (max-width:1000px){ .page{grid-template-columns:1fr} .hdr-controls .search input{width:120px} }

    .panel{background:var(--card);border-radius:var(--radius);padding:14px;border:1px solid rgba(255,255,255,0.02);box-shadow: 0 12px 30px rgba(0,0,0,0.6)}

    /* ==================== ENHANCED LESSONS ==================== */
    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:20px;
      flex-wrap:wrap;
      padding-bottom:15px;
      border-bottom:2px solid rgba(255,255,255,0.05);
    }
    .select{
      padding:10px 16px;
      border-radius:10px;
      background:rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.05);
      color:var(--text);
      font-weight:600;
      cursor:pointer;
      transition:all 0.3s ease;
    }
    .select:hover{
      border-color:var(--accent1);
      background:rgba(69,230,255,0.05);
    }
    .lessons-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:24px;
    }
    .lesson-card{
      border-radius:16px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:380px;
      transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border:1px solid rgba(255,255,255,0.05);
      background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      position:relative;
    }
    .lesson-card::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:linear-gradient(135deg, var(--accent1), var(--accent2));
      opacity:0;
      transition:opacity 0.4s ease;
      z-index:0;
    }
    .lesson-card:hover::before{
      opacity:0.03;
    }
    .lesson-card:hover{
      transform:translateY(-12px) scale(1.02);
      box-shadow:0 40px 80px rgba(0,0,0,0.7), 0 0 40px rgba(69,230,255,0.2);
      border-color:var(--accent1);
    }
    .lesson-thumb{
      width:100%;
      height:180px;
      object-fit:cover;
      display:block;
      filter:contrast(1.05) brightness(1.05);
      transition:transform 0.6s ease, filter 0.4s ease;
      position:relative;
      z-index:1;
    }
    .lesson-card:hover .lesson-thumb{
      transform:scale(1.15);
      filter:contrast(1.1) brightness(1.1);
    }
    .lesson-body{
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:12px;
      flex:1;
      position:relative;
      z-index:1;
    }
    .title{
      font-weight:800;
      font-size:19px;
      background:linear-gradient(135deg, var(--text), var(--accent1));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .meta{
      color:var(--muted);
      font-size:13px;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .price{
      font-weight:900;
      font-size:28px;
      background:linear-gradient(135deg, var(--accent1), var(--accent2));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      text-shadow:0 2px 10px rgba(69,230,255,0.3);
    }
    .spaces{
      font-weight:700;
      color:#bdf7f0;
      background:linear-gradient(135deg, rgba(69,230,255,0.1), rgba(58,226,122,0.1));
      padding:8px 14px;
      border-radius:20px;
      font-size:13px;
      border:1px solid rgba(69,230,255,0.2);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .spaces::before{
      content:'●';
      color:var(--success);
      animation:pulse 2s infinite;
    }
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .small{
      font-size:14px;
      line-height:1.6;
      color:var(--muted);
    }
    input{
      padding:12px 16px;
      border-radius:10px;
      border:2px solid rgba(255,255,255,0.05);
      background:rgba(255,255,255,0.02);
      color:var(--text);
      font-size:14px;
      transition:all 0.3s ease;
      outline:none;
    }
    input:focus{
      border-color:var(--accent1);
      background:rgba(69,230,255,0.05);
      box-shadow:0 0 0 3px rgba(69,230,255,0.1);
    }
    input.invalid{
      border-color:var(--danger);
    }
    label{
      display:block;
      margin-bottom:8px;
      font-weight:600;
      font-size:13px;
      color:var(--muted);
    }

    /* ==================== ENHANCED CART DRAWER ==================== */
    .cart-drawer-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.7);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      z-index:60;
      display:flex;
      justify-content:flex-end;
      animation:fadeIn 0.3s ease-out;
    }
    .cart-drawer{
      width:420px;
      background:linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      padding:24px;
      height:100vh;
      overflow:auto;
      border-left:2px solid rgba(69,230,255,0.2);
      box-shadow:-30px 0 80px rgba(0,0,0,0.8), 0 0 60px rgba(69,230,255,0.1);
      animation:slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .cart-item{
      display:flex;
      gap:15px;
      align-items:center;
      padding:15px;
      border-radius:12px;
      background:linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.05);
      margin-bottom:15px;
      transition:all 0.3s ease;
      animation:slideIn 0.3s ease-out;
    }
    .cart-item:hover{
      background:linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border-color:var(--accent1);
      transform:translateX(-5px);
      box-shadow:0 8px 25px rgba(0,0,0,0.4);
    }
    .mini{
      width:70px;
      height:70px;
      object-fit:cover;
      border-radius:10px;
      border:2px solid rgba(69,230,255,0.2);
      transition:transform 0.3s ease;
    }
    .cart-item:hover .mini{
      transform:scale(1.1);
      border-color:var(--accent1);
    }
    .cart-summary{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:15px;
      padding:20px;
      border-radius:12px;
      background:linear-gradient(135deg, var(--accent1), var(--accent2));
      font-weight:800;
      font-size:22px;
      color:#041427;
      box-shadow:0 8px 25px rgba(69,230,255,0.4);
    }

    /* ---------------- Checkout modal/receipt ---------------- */
    .modal-backdrop{position:fixed;inset:0;background:linear-gradient(180deg, rgba(0,0,0,0.65), rgba(0,0,0,0.8));display:flex;align-items:center;justify-content:center;z-index:80}
    .modal{width:760px;max-width:96%;border-radius:14px;background:linear-gradient(180deg, rgba(14,21,30,0.98), rgba(9,13,20,0.98));padding:18px;color:var(--text);box-shadow:0 30px 100px rgba(0,0,0,0.9)}
    .receipt-line{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed rgba(255,255,255,0.03);color:var(--muted)}
    .status-chip{padding:6px 10px;border-radius:999px;font-weight:800}
    .status-processing{background:rgba(255,255,255,0.02);color:var(--accent1)}
    .status-confirmed{background:rgba(58,226,122,0.06);color:var(--success)}

    /* ---------------- Settings panel (modal) ---------------- */
    .settings{position:fixed;right:18px;top:80px;width:320px;background:var(--card);padding:12px;border-radius:12px;box-shadow:var(--shadow);z-index:50}

    /* ---------------- Skeleton loader and empty states ---------------- */
    .skeleton{background:linear-gradient(90deg, rgba(255,255,255,0.015), rgba(255,255,255,0.03), rgba(255,255,255,0.015));height:12px;border-radius:6px;overflow:hidden}
    .skeleton.thumb{height:150px;border-radius:8px}
    .empty-state{padding:36px;text-align:center;color:var(--muted);border-radius:10px;background:rgba(255,255,255,0.01)}

    /* ---------------- Toast ---------------- */
    .toast{position:fixed;right:20px;bottom:20px;padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#041427;font-weight:800;z-index:90;box-shadow:0 14px 40px rgba(124,107,255,0.08)}
    .toast .icon{margin-right:8px}

    /* ---------------- Animations ---------------- */
    .fade-enter-active, .fade-leave-active { transition: all .28s cubic-bezier(.2,.9,.3,1); }
    .fade-enter, .fade-leave-to { opacity:0; transform: translateY(8px); }

    /* print receipt area only */
    @media print {
      body * { visibility: hidden; }
      .print-area, .print-area * { visibility: visible; }
      .print-area { position: absolute; left: 0; top: 0; width:100% }
    }
  </style>
</head>
<body>
  <div id="app" class="container">

    <!-- Header -->
    <header class="app-header">
      <div class="brand">
        <div class="logo">AS</div>
        <div>
          <div class="title">After School Program</div>
          <div class="sub">Book lessons and activities</div>
        </div>
      </div>

      <div class="hdr-controls">
        <div class="search" v-if="loggedIn">
          <i class="fa fa-search" style="color:var(--muted)"></i>
          <input v-model="q" @input="applyFilters" placeholder="Search lessons, teacher, location..." />
        </div>

        <select class="select" v-model="filterCategory" v-if="loggedIn" @change="applyFilters">
          <option value="">All subjects</option>
          <option v-for="s in uniqueSubjects" :key="s">{{ s }}</option>
        </select>

        <select class="select" v-model="sortBy" v-if="loggedIn" @change="sortLessons">
          <option value="subject">Sort: Subject</option>
          <option value="location">Sort: Location</option>
          <option value="price">Sort: Price</option>
          <option value="spaces">Sort: Spaces</option>
        </select>

        <button class="btn ghost" @click="toggleSortOrder" title="Toggle sort order" v-if="loggedIn">
          <i class="fa" :class="sortOrder === 'asc' ? 'fa-arrow-up' : 'fa-arrow-down'"></i>
        </button>

        <button class="btn ghost" @click="openSettings" title="Settings">
          <i class="fa fa-cog"></i>
        </button>

        <button class="btn" @click="toggleTheme" :title="themeLabel">
          <i class="fa" :class="darkMode ? 'fa-moon' : 'fa-sun'"></i>
        </button>
      </div>
    </header>

    <!-- PAGE -->
    <div v-if="!loggedIn" style="margin-top:28px;">
      <!-- Login card -->
      <div class="panel" style="max-width:520px;margin:18px auto;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <div style="width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent1));display:flex;align-items:center;justify-content:center;font-weight:800;color:#041427">AS</div>
          <div>
            <div style="font-weight:900;font-size:20px">Student login</div>
            <div class="meta">Sign in with your Student ID (format: M########)</div>
          </div>
        </div>

        <div style="margin-top:8px">
          <label class="small">Student name</label>
          <input type="text" v-model.trim="loginName" placeholder="Full name" :class="{invalid: loginName && !nameOk}">
        </div>

        <div style="margin-top:12px">
          <label class="small">Student ID (M########)</label>
          <input type="text" v-model.trim="loginId" placeholder="M00001234" maxlength="9" :class="{invalid: loginId && !idOk}">
          <div v-if="loginId && !idOk" style="color:var(--danger);margin-top:6px" class="small">ID must start with 'M' followed by 8 digits.</div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:18px">
          <button class="btn ghost" @click="fillTestCredentials">Quick fill</button>
          <button class="btn primary" :disabled="!canLogin" @click="doLogin"><i class="fa fa-sign-in-alt"></i> Enter</button>
        </div>
      </div>
    </div>

    <div v-else class="page" style="margin-top:20px">
      <!-- Left: lessons -->
      <section>
        <div class="panel">
          <div class="controls">
            <div class="small muted">Showing <strong>{{ filteredLessons.length }}</strong> lessons</div>
            <div style="flex:1"></div>

            <div class="small muted">Layout</div>
            <button class="btn ghost" @click="viewMode='grid'"><i class="fa fa-th-large"></i></button>
            <button class="btn ghost" @click="viewMode='list'"><i class="fa fa-list"></i></button>
          </div>

          <!-- skeleton while loading -->
          <div v-if="loadingLessons">
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px">
              <div v-for="n in 6" :key="n" style="border-radius:12px;padding:10px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005))">
                <div class="skeleton thumb" style="margin-bottom:8px"></div>
                <div class="skeleton" style="width:70%;height:14px;margin-bottom:6px"></div>
                <div class="skeleton" style="width:50%;height:12px;margin-bottom:6px"></div>
                <div class="skeleton" style="width:100%;height:12px;margin-top:10px"></div>
              </div>
            </div>
          </div>

          <!-- error / empty -->
          <div v-else-if="lessonsError" class="empty-state">
            <div style="font-weight:800;margin-bottom:6px">Unable to load lessons</div>
            <div class="small muted" style="margin-bottom:12px">There was a problem retrieving lessons from the server. Check the backend and try again.</div>
            <div>
              <button class="btn primary" @click="loadLessons">Retry</button>
            </div>
          </div>

          <div v-else-if="filteredLessons.length===0" class="empty-state">
            <div style="font-weight:800;margin-bottom:8px">No lessons found</div>
            <div class="small muted">Try a different search or filter.</div>
          </div>

          <!-- lessons list -->
          <div v-else>
            <div v-if="viewMode==='grid'" class="lessons-grid">
              <transition-group name="fade" tag="div">
                <div v-for="lesson in filteredLessons" :key="lesson._id || lesson.id" class="lesson-card">
                  <img :src="lesson.thumb" class="lesson-thumb" alt="thumb" />
                  <div class="lesson-body">
                    <div>
                      <div class="title">{{ lesson.subject }}</div>
                      <div class="meta">{{ lesson.location }} • Teacher: {{ lesson.teacher }} • Room: {{ lesson.room }}</div>
                      <p class="small" style="margin-top:8px">{{ lesson.description }}</p>
                    </div>

                    <div style="margin-top:auto" class="row" >
                      <div>
                        <div class="price">£{{ Number(lesson.price).toFixed(2) }}</div>
                        <div class="spaces" style="margin-top:8px">Spaces: {{ lesson.spaces }}</div>
                      </div>
                      <div>
                        <button class="btn primary" :disabled="lesson.spaces<=0" @click="addToCart(lesson)">
                          <i class="fa fa-cart-plus"></i> Add
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </transition-group>
            </div>

            <div v-else>
              <transition-group name="fade" tag="div">
                <div v-for="lesson in filteredLessons" :key="'list-'+(lesson._id||lesson.id)" class="lesson-card" style="flex-direction:row;gap:12px;align-items:flex-start;padding:0">
                  <img :src="lesson.thumb" style="width:220px;height:130px;object-fit:cover;border-radius:8px;margin:12px" alt="thumb">
                  <div style="flex:1;padding:12px">
                    <div class="title">{{ lesson.subject }}</div>
                    <div class="meta">{{ lesson.location }} • {{ lesson.teacher }} • Room: {{ lesson.room }}</div>
                    <p class="small" style="margin-top:8px">{{ lesson.description }}</p>
                  </div>
                  <div style="width:180px;padding:12px;text-align:right;display:flex;flex-direction:column;justify-content:center">
                    <div class="price">£{{ Number(lesson.price).toFixed(2) }}</div>
                    <div class="spaces" style="margin-top:8px">Spaces: {{ lesson.spaces }}</div>
                    <div style="margin-top:12px">
                      <button class="btn primary" :disabled="lesson.spaces<=0" @click="addToCart(lesson)">Add</button>
                    </div>
                  </div>
                </div>
              </transition-group>
            </div>
          </div>
        </div>
      </section>

      <!-- Right: cart drawer / mini -->
      <aside>
        <div class="panel" style="position:relative">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:900">Cart</div>
            <div style="text-align:right">
              <div class="small muted">Items: {{ totalItems }}</div>
              <div style="font-weight:900;font-size:18px">£{{ subtotal.toFixed(2) }}</div>
            </div>
          </div>

          <hr style="border:none;height:12px">

          <div v-if="cart.length===0" class="empty-state">Your cart is empty</div>

          <div v-else>
            <div v-for="(it, idx) in cart" :key="'c-'+idx" class="cart-item">
              <div style="display:flex;gap:10px;align-items:center;flex:1">
                <img :src="it.thumb" class="mini" alt="">
                <div>
                  <div style="font-weight:800">{{ it.subject }}</div>
                  <div class="small muted">{{ it.teacher }} • {{ it.room }}</div>
                </div>
              </div>
              <div style="text-align:right;min-width:130px;">
                <div>£{{ (it.price*it.qty).toFixed(2) }}</div>
                <div style="margin-top:6px;display:flex;gap:6px;justify-content:flex-end">
                  <button class="btn ghost" @click="increaseQty(idx)"><i class="fa fa-plus"></i></button>
                  <button class="btn ghost" @click="decreaseQty(idx)"><i class="fa fa-minus"></i></button>
                  <button class="btn" style="background:var(--danger);color:#041427" @click="removeFromCart(idx)"><i class="fa fa-trash"></i></button>
                </div>
              </div>
            </div>

            <div class="cart-summary">
              <div class="small muted">Total</div>
              <div>£{{ subtotal.toFixed(2) }}</div>
            </div>

            <div style="margin-top:10px;display:flex;gap:8px">
              <button class="btn primary" @click="openCartDrawer"><i class="fa fa-shopping-cart"></i> Open Cart</button>
              <button class="btn ghost" @click="clearCart">Clear</button>
              <button class="btn ghost" @click="openOrderHistory">Order history</button>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- Cart Drawer (slide-in) -->
    <transition name="fade">
      <div v-if="cartOpen" class="cart-drawer-backdrop" @click.self="closeCartDrawer">
        <div class="cart-drawer" @keydown.esc="closeCartDrawer">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:900">Your Cart</div>
            <div style="display:flex;gap:8px;align-items:center">
              <div class="small muted">Items: {{ totalItems }}</div>
              <button class="btn ghost" @click="closeCartDrawer"><i class="fa fa-times"></i></button>
            </div>
          </div>

          <div v-if="cart.length===0" class="empty-state">Your cart is empty</div>

          <div v-else>
            <div v-for="(it, idx) in cart" :key="'drawer-'+idx" class="cart-item">
              <div style="display:flex;gap:10px;align-items:center;flex:1">
                <img :src="it.thumb" class="mini" alt="">
                <div>
                  <div style="font-weight:800">{{ it.subject }}</div>
                  <div class="small muted">{{ it.teacher }} • {{ it.room }}</div>
                </div>
              </div>

              <div style="text-align:right;min-width:140px;">
                <div>£{{ (it.price*it.qty).toFixed(2) }}</div>
                <div style="margin-top:8px;display:flex;gap:6px;justify-content:flex-end">
                  <button class="btn ghost" @click="increaseQty(idx)"><i class="fa fa-plus"></i></button>
                  <button class="btn ghost" @click="decreaseQty(idx)"><i class="fa fa-minus"></i></button>
                  <button class="btn" style="background:var(--danger);color:#041427" @click="removeFromCart(idx)"><i class="fa fa-trash"></i></button>
                </div>
              </div>
            </div>

            <div class="cart-summary" style="margin-top:8px">
              <div class="small muted">Subtotal</div>
              <div>£{{ subtotal.toFixed(2) }}</div>
            </div>

            <div style="margin-top:10px">
              <div style="margin-bottom:8px" class="small muted">Student</div>
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input disabled :value="student.name" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:transparent;color:var(--text)">
                <input disabled :value="student.id" style="width:140px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:transparent;color:var(--text)">
              </div>

              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input v-model.trim="checkout.firstName" placeholder="First name" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:transparent;color:var(--text)">
                <input v-model.trim="checkout.lastName" placeholder="Last name" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:transparent;color:var(--text)">
              </div>

              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input v-model.trim="checkout.phone" placeholder="Phone" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:transparent;color:var(--text)">
                <input v-model.trim="checkout.email" placeholder="Email (optional)" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:transparent;color:var(--text)">
              </div>

              <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
                <label style="display:flex;gap:8px;align-items:center"><input type="radio" value="card" v-model="checkout.payment"> Card</label>
                <label style="display:flex;gap:8px;align-items:center"><input type="radio" value="cash" v-model="checkout.payment"> Cash</label>
              </div>

              <div v-if="checkout.payment==='card'" style="display:flex;gap:8px;margin-bottom:8px">
                <input v-model.trim="checkout.cardNumber" placeholder="Card number" style="flex:2;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:transparent;color:var(--text)">
                <input v-model.trim="checkout.expiry" placeholder="MM/YY" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:transparent;color:var(--text)">
                <input v-model.trim="checkout.cvv" placeholder="CVV" style="width:90px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:transparent;color:var(--text)">
              </div>

              <div style="display:flex;gap:8px">
                <button class="btn primary" :disabled="!canCheckout" @click="beginCheckout">Pay & Submit</button>
                <button class="btn ghost" @click="saveCartToLocal">Save</button>
                <button class="btn ghost" @click="closeCartDrawer">Close</button>
              </div>
            </div>
          </div>
        </div>
      </transition>

    <!-- Settings panel -->
    <transition name="fade">
      <div v-if="settingsOpen" class="settings panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:800">Settings</div>
          <button class="btn ghost" @click="settingsOpen=false"><i class="fa fa-times"></i></button>
        </div>

        <div style="margin-bottom:10px">
          <div class="small muted">Theme</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" :class="{primary: darkMode}" @click="setTheme(true)">Dark</button>
            <button class="btn" :class="{primary: !darkMode}" @click="setTheme(false)">Light</button>
          </div>
        </div>

        <div style="margin-bottom:10px">
          <div class="small muted">Layout</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" :class="{primary: viewMode==='grid'}" @click="viewMode='grid'">Grid</button>
            <button class="btn" :class="{primary: viewMode==='list'}" @click="viewMode='list'">List</button>
          </div>
        </div>

        <div>
          <div class="small muted">Accent color</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" @click="setAccent('blue')" style="background:linear-gradient(90deg,#45e6ff,#7c6bff);color:#041427">Blue</button>
            <button class="btn" @click="setAccent('green')" style="background:linear-gradient(90deg,#00c1b4,#3ae27a);color:#041427">Green</button>
            <button class="btn" @click="setAccent('pink')" style="background:linear-gradient(90deg,#ff7acb,#ffd97a);color:#041427">Pink</button>
          </div>
        </div>
      </div>
    </transition>

    <!-- Receipt Modal -->
    <transition name="fade">
      <div v-if="showReceipt" class="modal-backdrop">
        <div class="modal print-area">
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div>
              <div style="display:flex;gap:10px;align-items:center">
                <div style="width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent2),var(--accent1));display:flex;align-items:center;justify-content:center;font-weight:800;color:#041427">AS</div>
                <div>
                  <div style="font-weight:900;font-size:18px">After School Program</div>
                  <div class="small muted">Receipt • {{ new Date().toLocaleString() }}</div>
                </div>
              </div>
            </div>

            <div style="text-align:right">
              <div :class="['status-chip', lastOrder.state === 'processing' ? 'status-processing' : 'status-confirmed']">
                {{ lastOrder.state === 'processing' ? 'Processing' : 'Confirmed' }}
              </div>
              <div class="small muted" style="margin-top:8px">Order ID: <strong>{{ lastOrder.orderId || '—' }}</strong></div>
            </div>
          </div>

          <div style="margin-top:14px;padding:12px;border-radius:8px;background:rgba(255,255,255,0.01)">
            <div class="small muted">Student</div>
            <div style="font-weight:900">{{ student.name }} • {{ student.id }}</div>
            <div class="small muted" style="margin-top:6px">Contact: {{ lastOrder.contact || '—' }}</div>
          </div>

          <div style="margin-top:14px">
            <div class="small muted">Items</div>
            <div style="margin-top:8px;border-radius:8px;overflow:hidden">
              <div v-for="it in lastOrder.items" :key="it.id" class="receipt-line">
                <div>{{ it.subject }} × {{ it.qty }}</div>
                <div>£{{ (it.price * it.qty).toFixed(2) }}</div>
              </div>
              <div class="receipt-line" style="font-weight:900">
                <div>Total</div>
                <div>£{{ lastOrder.total.toFixed(2) }}</div>
              </div>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
            <div class="small muted">Payment method: <strong>{{ lastOrder.payment }}</strong></div>
            <div style="display:flex;gap:8px">
              <button class="btn ghost" @click="showReceipt=false">Close</button>
              <button class="btn" @click="downloadReceipt"><i class="fa fa-download"></i> Download</button>
              <button class="btn primary" @click="printReceipt"><i class="fa fa-print"></i> Print Confirmation</button>
            </div>
          </div>
        </div>
      </div>
    </transition>

    <!-- Order history modal -->
    <transition name="fade">
      <div v-if="historyOpen" class="modal-backdrop" @click.self="historyOpen=false">
        <div class="modal">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:900">Order history</div>
            <button class="btn ghost" @click="historyOpen=false"><i class="fa fa-times"></i></button>
          </div>

          <div v-if="historyLoading" style="margin-top:12px">
            <div class="skeleton" style="height:12px;margin-bottom:8px"></div>
            <div class="skeleton" style="height:12px;margin-bottom:8px"></div>
            <div class="skeleton" style="height:12px;margin-bottom:8px"></div>
          </div>

          <div v-else-if="history.length===0" class="empty-state" style="margin-top:12px">
            No previous orders were found for this student.
          </div>

          <div v-else style="margin-top:12px">
            <div v-for="o in history" :key="o.orderId" style="padding:12px;border-radius:8px;background:rgba(255,255,255,0.01);margin-bottom:10px">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div><strong>Order</strong> • {{ o.orderId || '—' }}</div>
                <div class="small muted">{{ new Date(o.createdAt).toLocaleString() }}</div>
              </div>
              <div style="margin-top:8px">
                <div v-for="it in o.items" :key="it.id" style="display:flex;justify-content:space-between">
                  <div class="small">{{ it.subject }} × {{ it.qty }}</div>
                  <div class="small">£{{ (it.price * it.qty).toFixed(2) }}</div>
                </div>
                <div style="display:flex;justify-content:space-between;margin-top:8px;font-weight:800">
                  <div>Total</div>
                  <div>£{{ o.total.toFixed(2) }}</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </transition>

    <!-- Toast -->
    <div v-if="toast" class="toast"><span class="icon"><i class="fa fa-check"></i></span>{{ toast }}</div>
  </div>

  <script>
    // ---------------- CONFIG: change to your backend URL (Express) ----------------
    const BACKEND_BASE = 'http://localhost:3000'; // e.g. 'http://localhost:3000' or your render.com route

    new Vue({
      el:'#app',
      data: function(){
        return {
          // auth
          loggedIn:false,
          loginName:'',
          loginId:'',
          student:{ name:'', id:'' },

          // lessons
          lessons: [],
          loadingLessons:false,
          lessonsError:false,

          // UI / filters
          q:'',
          filterCategory:'',
          sortBy:'subject',
          sortOrder:'asc',
          viewMode:'grid',

          // cart
          cart:[],
          cartOpen:false,

          // checkout fields (drawer)
          checkout:{ firstName:'', lastName:'', phone:'', email:'', payment:'card', cardNumber:'', expiry:'', cvv:'' },

          // receipt & processing
          showReceipt:false,
          lastOrder:{ items:[], total:0, payment:'', orderId:null, contact:'', state:'processing' },

          // order history
          historyOpen:false,
          history:[],
          historyLoading:false,

          // settings
          settingsOpen:false,
          darkMode:true,

          // toast
          toast:''
        };
      },
      computed:{
        nameOk(){ return /^[A-Za-z\s]{2,}$/.test(this.loginName) },
        idOk(){ return /^M\d{8}$/.test(this.loginId) },
        canLogin(){ return this.nameOk && this.idOk },

        filteredLessons(){
          const q = (this.q||'').toLowerCase().trim();
          let arr = this.lessons.slice();
          if(this.filterCategory) arr = arr.filter(l => (l.subject || '').toLowerCase() === this.filterCategory.toLowerCase());
          if(q) arr = arr.filter(l => {
            const hay = (l.subject + ' ' + l.location + ' ' + l.teacher + ' ' + l.room + ' ' + l.description + ' ' + l.price + ' ' + l.spaces).toLowerCase();
            return hay.indexOf(q) !== -1;
          });
          arr.sort(this.sortComparator);
          return arr;
        },
        uniqueSubjects(){
          const set = new Set(this.lessons.map(l => l.subject).filter(Boolean));
          return Array.from(set).sort();
        },

        totalItems(){ return this.cart.reduce((s, it) => s + it.qty, 0) },
        subtotal(){ return this.cart.reduce((s, it) => s + (it.price * it.qty), 0) },

        firstNameValid(){ return /^[A-Za-z\s]{2,}$/.test(this.checkout.firstName) },
        lastNameValid(){ return /^[A-Za-z\s]{2,}$/.test(this.checkout.lastName) },
        phoneValid(){ return /^[0-9]{7,15}$/.test(this.checkout.phone) },
        cardValid(){ return this.checkout.payment !== 'card' || /^[0-9]{12,19}$/.test(this.checkout.cardNumber) },
        canCheckout(){ return this.cart.length>0 && this.firstNameValid && this.lastNameValid && this.phoneValid && this.cardValid; },

        sortOrderLabel(){ return this.sortOrder === 'asc' ? 'Asc' : 'Desc' },
        themeLabel(){ return this.darkMode ? 'Dark mode' : 'Light mode' }
      },
      created(){
        // load persisted settings if any
        try {
          const s = localStorage.getItem('afterschool_settings');
          if(s){
            const parsed = JSON.parse(s);
            if(typeof parsed.darkMode !== 'undefined') this.darkMode = parsed.darkMode;
            if(parsed.viewMode) this.viewMode = parsed.viewMode;
            if(parsed.accent) this.applyAccent(parsed.accent);
          }
        } catch(e){ console.warn('settings load failed', e) }
        this.applyTheme();
        // attempt to load lessons (backend required)
        this.loadLessons();
      },
      methods:{
        // ---------------- Theme / Accent ----------------
        applyTheme(){
          document.body.classList.toggle('light-theme', !this.darkMode);
        },
        toggleTheme(){
          this.darkMode = !this.darkMode;
          this.applyTheme();
          this.saveSettings();
        },
        setTheme(isDark){ this.darkMode = !!isDark; this.applyTheme(); this.saveSettings(); },
        setAccent(name){
          // a few accents
          if(name==='green') this.applyAccent({accent1:'#00c1b4',accent2:'#3ae27a'});
          else if(name==='pink') this.applyAccent({accent1:'#ff7acb',accent2:'#ffd97a'});
          else this.applyAccent({accent1:'#45e6ff',accent2:'#7c6bff'});
          this.saveSettings();
        },
        applyAccent(cfg){
          if(typeof cfg === 'string') return;
          if(cfg.accent1) document.documentElement.style.setProperty('--accent1', cfg.accent1);
          if(cfg.accent2) document.documentElement.style.setProperty('--accent2', cfg.accent2);
        },
        saveSettings(){
          const obj = { darkMode: this.darkMode, viewMode: this.viewMode };
          localStorage.setItem('afterschool_settings', JSON.stringify(obj));
        },

        // ---------------- Lessons ----------------
        loadLessons(){
          this.loadingLessons = true;
          this.lessonsError = false;
          
          // Try to fetch from backend first
          fetch(BACKEND_BASE + '/lessons')
            .then(r => { if(!r.ok) throw new Error('Network response not ok'); return r.json(); })
            .then(data => {
              this.lessons = data.map((d,i) => ({
                _id: d._id || d.id || (i+1),
                id: d._id || d.id || (i+1),
                subject: d.subject || d.topic || 'Lesson',
                location: d.location || 'Unknown',
                price: Number(d.price || d.cost || 0),
                spaces: (typeof d.spaces !== 'undefined') ? d.spaces : (d.space || 0),
                teacher: d.teacher || 'Staff',
                room: d.room || d.venue || '',
                description: d.description || '',
                thumb: d.thumb || d.image || ''
              }));
              this.loadingLessons = false;
            })
            .catch(err => {
              console.warn('Backend not available, using embedded data', err);
              // Use embedded data if backend fails
              this.lessons = [
                {id:1,subject:"English",location:"Oxford",price:22,spaces:5,teacher:"Ms Smith",room:"B2",description:"Reading, comprehension & writing.",thumb:"https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=400&q=60"},
                {id:2,subject:"Science",location:"Bristol",price:28,spaces:5,teacher:"Dr Green",room:"C3",description:"Hands-on science experiments.",thumb:"https://images.unsplash.com/photo-1531219432768-3f2b5b6a3a9f?auto=format&fit=crop&w=400&q=60"},
                {id:3,subject:"History",location:"York",price:18,spaces:5,teacher:"Mrs Jones",room:"D1",description:"Explore the past and civilisations.",thumb:"https://images.unsplash.com/photo-1532012197267-da84d127e765?auto=format&fit=crop&w=400&q=60"},
                {id:4,subject:"Geography",location:"London",price:20,spaces:5,teacher:"Mr Lee",room:"E2",description:"Maps, climates, and cultures.",thumb:"https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=400&q=60"},
                {id:5,subject:"Art",location:"Bristol",price:19,spaces:5,teacher:"Ms Turner",room:"F3",description:"Drawing and painting techniques.",thumb:"https://images.unsplash.com/photo-1517694712202-14dd9538aa97?auto=format&fit=crop&w=400&q=60"},
                {id:6,subject:"Music",location:"Oxford",price:24,spaces:5,teacher:"Mr Davis",room:"G1",description:"Instruments and musical theory.",thumb:"https://images.unsplash.com/photo-1511379938547-c1f69419868d?auto=format&fit=crop&w=400&q=60"},
                {id:7,subject:"Physical Education",location:"London",price:21,spaces:5,teacher:"Coach Ray",room:"Hall",description:"Fitness, team sports & skills.",thumb:"https://images.unsplash.com/photo-1517649763962-0c623066013b?auto=format&fit=crop&w=400&q=60"},
                {id:8,subject:"Computer Science",location:"Cambridge",price:30,spaces:5,teacher:"Ms Code",room:"Lab 1",description:"Intro to programming and logic.",thumb:"https://images.unsplash.com/photo-1518779578993-ec3579fee39f?auto=format&fit=crop&w=400&q=60"},
                {id:9,subject:"Drama",location:"York",price:17,spaces:5,teacher:"Mrs Hale",room:"Studio",description:"Acting, improv & stagecraft.",thumb:"https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d?auto=format&fit=crop&w=400&q=60"},
                {id:10,subject:"Mathematics",location:"London",price:25,spaces:5,teacher:"Mr Adams",room:"A1",description:"Algebra and geometry fundamentals.",thumb:"https://images.unsplash.com/photo-1526378724216-99b7a7e3beba?auto=format&fit=crop&w=400&q=60"}
              ];
              this.loadingLessons = false;
              this.lessonsError = false;
            });
        },

        // ---------------- Sorting & filtering ----------------
        applyFilters(){ /* reactive via computed */ },
        sortLessons(){ /* reactive */ },
        sortComparator(a,b){
          let key = this.sortBy;
          let av = key==='subject'? a.subject : (key==='location'? a.location : (key==='price'? a.price : a.spaces));
          let bv = key==='subject'? b.subject : (key==='location'? b.location : (key==='price'? b.price : b.spaces));
          if(typeof av === 'string') av = av.toLowerCase();
          if(typeof bv === 'string') bv = bv.toLowerCase();
          if(av < bv) return this.sortOrder === 'asc' ? -1 : 1;
          if(av > bv) return this.sortOrder === 'asc' ? 1 : -1;
          return 0;
        },
        toggleSortOrder(){ this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc' },

        // ---------------- Login ----------------
        fillTestCredentials(){ this.loginName = 'Tanya Murombe'; this.loginId = 'M00001234'; },
        doLogin(){
          if(!this.canLogin){ alert('Please enter valid name and student ID'); return; }
          this.student.name = this.loginName.trim();
          this.student.id = this.loginId.trim();
          this.loggedIn = true;
          this.showToast('Welcome ' + this.student.name);
          // load order history for student optionally
          this.loadOrderHistory();
        },

        // ---------------- Cart operations ----------------
        addToCart(lesson){
          if(lesson.spaces <= 0){ this.showToast('No spaces left'); return; }
          const id = lesson._id || lesson.id;
          const found = this.cart.find(i => i.id === id);
          if(found) found.qty++;
          else this.cart.push({ id: id, subject: lesson.subject, price: lesson.price, qty: 1, teacher: lesson.teacher, room: lesson.room, thumb: lesson.thumb });
          // decrement local spaces so it appears reserved
          const L = this.lessons.find(l => (l._id || l.id) === id);
          if(L) L.spaces = Math.max(0, L.spaces - 1);
          this.showToast(lesson.subject + ' added');
        },
        removeFromCart(index){
          const it = this.cart[index];
          const lesson = this.lessons.find(l => (l._id || l.id) === it.id);
          if(lesson) lesson.spaces += it.qty;
          // keep an undo kit
          const removed = this.cart.splice(index,1)[0];
          this.showTempUndo(removed, index);
        },
        increaseQty(i){
          const it = this.cart[i];
          const lesson = this.lessons.find(l => (l._id || l.id) === it.id);
          if(lesson && lesson.spaces>0){ it.qty++; lesson.spaces--; } else this.showToast('No more spaces');
        },
        decreaseQty(i){
          const it = this.cart[i];
          const lesson = this.lessons.find(l => (l._id || l.id) === it.id);
          if(it.qty>1){ it.qty--; if(lesson) lesson.spaces++; } else { if(lesson) lesson.spaces += 1; this.cart.splice(i,1); }
        },
        clearCart(){
          // restore spaces
          this.cart.forEach(it => {
            const lesson = this.lessons.find(l => (l._id || l.id) === it.id);
            if(lesson) lesson.spaces += it.qty;
          });
          this.cart = [];
          this.showToast('Cart cleared');
        },
        saveCartToLocal(){
          try{
            localStorage.setItem('afterschool_cart', JSON.stringify(this.cart));
            this.showToast('Cart saved locally');
          }catch(e){ this.showToast('Save failed'); }
        },

        // ---------------- Cart drawer & settings ----------------
        openCartDrawer(){ this.cartOpen = true; },
        closeCartDrawer(){ this.cartOpen = false; },
        openSettings(){ this.settingsOpen = true; },
        openOrderHistory(){ this.historyOpen = true; this.loadOrderHistory(); },

        // ---------------- Checkout flow ----------------
        beginCheckout(){
          if(!this.canCheckout){ alert('Please complete the form and ensure cart has items'); return; }
          const orderItems = this.cart.map(it => ({ id: it.id, subject: it.subject, qty: it.qty, price: it.price }));
          const payload = {
            studentName: this.student.name,
            studentId: this.student.id,
            firstName: this.checkout.firstName,
            lastName: this.checkout.lastName,
            phone: this.checkout.phone,
            email: this.checkout.email || null,
            payment: this.checkout.payment,
            card: (this.checkout.payment==='card') ? { number: this.checkout.cardNumber, expiry: this.checkout.expiry, cvv: this.checkout.cvv } : null,
            items: orderItems,
            total: this.subtotal,
            createdAt: new Date().toISOString()
          };

          // show processing modal
          this.lastOrder = { items: orderItems, total: this.subtotal, payment: this.checkout.payment, orderId: null, contact: this.checkout.email || this.checkout.phone || '', state: 'processing' };
          this.showReceipt = true;

          // POST to backend checkout endpoint
          fetch(BACKEND_BASE + '/checkout', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          })
          .then(r => {
            if(!r.ok) return r.json().then(err => Promise.reject(err));
            return r.json();
          })
          .then(resp => {
            // simulate short processing then confirm
            setTimeout(()=> {
              this.lastOrder.orderId = resp.orderId || resp.id || ('ORD-'+Math.random().toString(36).slice(2,9).toUpperCase());
              this.lastOrder.state = 'confirmed';
              this.showToast('Payment confirmed — receipt ready');
              // clear cart and reset checkout
              this.cart = [];
              this.checkout = { firstName:'', lastName:'', phone:'', email:'', payment:'card', cardNumber:'', expiry:'', cvv:'' };
              // refresh lessons to sync spaces (best-effort)
              setTimeout(()=> this.loadLessons(), 400);
              // refresh history
              this.loadOrderHistory();
            }, 900);
          })
          .catch(err => {
            console.error('Checkout failed', err);
            // fallback: confirm locally without server id
            setTimeout(()=> {
              this.lastOrder.orderId = null;
              this.lastOrder.state = 'confirmed';
              this.showToast('Order stored locally (server failed)');
              this.cart = [];
              this.checkout = { firstName:'', lastName:'', phone:'', email:'', payment:'card', cardNumber:'', expiry:'', cvv:'' };
              this.loadOrderHistory();
            }, 900);
          });
        },

        // ---------------- Order history ----------------
        loadOrderHistory(){
          if(!this.student.id) return;
          this.historyLoading = true; this.history = [];
          fetch(BACKEND_BASE + '/orders?studentId=' + encodeURIComponent(this.student.id))
            .then(r => { if(!r.ok) throw new Error('Network'); return r.json(); })
            .then(data => {
              this.history = Array.isArray(data) ? data : [];
              this.historyLoading = false;
            })
            .catch(err => {
              console.warn('Order history failed', err);
              this.historyLoading = false;
            });
        },

        // ---------------- Receipt helpers ----------------
        downloadReceipt(){
          const lines = [];
          lines.push('After School Program — Receipt');
          lines.push('Student: ' + this.student.name + ' (' + this.student.id + ')');
          lines.push('Date: ' + new Date().toLocaleString());
          lines.push('Order ID: ' + (this.lastOrder.orderId || '—'));
          lines.push('---');
          this.lastOrder.items.forEach(it => lines.push(it.subject + ' x' + it.qty + ' — £' + (it.price*it.qty).toFixed(2)));
          lines.push('---');
          lines.push('Total: £' + this.lastOrder.total.toFixed(2));
          lines.push('Payment: ' + this.lastOrder.payment);
          const blob = new Blob([lines.join('\n')], { type:'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = 'receipt.txt'; a.click();
          URL.revokeObjectURL(url);
        },
        printReceipt(){ window.print(); },

        // ---------------- small UX helpers ----------------
        showToast(msg){ this.toast = msg; setTimeout(()=> this.toast = '', 3000); },

        showTempUndo(removed, index){
          // very small undo implementation via confirm toast
          this.showToast('Removed — click undo to restore');
          // store temporary state for 5s
          const that = this;
          const timer = setTimeout(()=> {
            // after timeout we drop possibility to undo
          }, 5000);

          // attach temporary undo method
          const undo = function(){
            clearTimeout(timer);
            that.cart.splice(index, 0, removed);
            that.showToast('Undo — item restored');
          };
          // show browser confirm to undo (quick): you can improve to show a real undo button inside toast
          setTimeout(()=> {
            if(confirm('Undo removal? (click OK to restore)')) undo();
          }, 10);
        }
      }
    });
  </script>
</body>
</html>
